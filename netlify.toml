[build]
  publish = "public"
  command = """
    set -e
    echo "=== Starting build ==="
    echo -n "Node: "; node --version || true
    echo -n "Hugo: "; hugo version
    echo -n "Go: "; go version || true

    echo "=== Enable pnpm (Corepack) ==="
    corepack enable
    corepack prepare pnpm@9.12.0 --activate
    echo -n "pnpm: "; pnpm --version

    echo "=== Installing dependencies ==="
    pnpm install --frozen-lockfile || pnpm install

    echo "=== Hugo build ==="
    hugo --gc --minify -b "$URL" --logLevel debug --printI18nWarnings --printPathWarnings

    echo "=== Pagefind index ==="
    pnpm dlx pagefind --source 'public' --verbose

    echo "=== Done ==="
  """

[build.environment]
  HUGO_VERSION = "0.152.2"
  NODE_VERSION = "20"
  GO_VERSION = "1.25.5"
  HUGO_ENV = "production"
  HUGO_ENABLEGITINFO = "true"
  FORCE_COLOR = "1"
  PNPM_LOG_LEVEL = "info"

[context.production.environment]
  HUGO_ENV = "production"

[context.deploy-preview]
  command = """
    set -e
    echo "=== Deploy Preview Build ==="
    echo "Deploy URL: $DEPLOY_PRIME_URL"
    corepack enable
    corepack prepare pnpm@9.12.0 --activate
    pnpm install --frozen-lockfile || pnpm install
    hugo --gc --minify --buildFuture -b "$DEPLOY_PRIME_URL" --logLevel debug --printI18nWarnings --printPathWarnings
    pnpm dlx pagefind --source 'public' --verbose
  """

[context.branch-deploy]
  command = """
    set -e
    echo "=== Branch Deploy Build ==="
    echo "Deploy URL: $DEPLOY_PRIME_URL"
    corepack enable
    corepack prepare pnpm@9.12.0 --activate
    pnpm install --frozen-lockfile || pnpm install
    hugo --gc --minify -b "$DEPLOY_PRIME_URL" --logLevel debug --printI18nWarnings --printPathWarnings
    pnpm dlx pagefind --source 'public' --verbose
  """

[[plugins]]
  package = "netlify-plugin-hugo-cache-resources"
  [plugins.inputs]
    debug = true

# ---------- Security headers ----------
[[headers]]
  for = "/*"
  [headers.values]
    Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"
    X-Content-Type-Options    = "nosniff"
    Referrer-Policy           = "strict-origin-when-cross-origin"
    Permissions-Policy        = "geolocation=(), microphone=(), camera=()"

# ---------- UTM Redirects ----------
[[redirects]]
  from = "/go/FoSS"
  to = "https://historicwindow.netlify.app/?utm_source=followupemail&utm_campaign=FoSS2025"
  status = 302
  force = true